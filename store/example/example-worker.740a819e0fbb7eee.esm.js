(()=>{"use strict";var t,e,s={6142:(t,e,s)=>{s(8868),s(4861),s(3045),s(6609),s(358);function i(t=8){return Array.from(new Array(t)).map((()=>String.fromCharCode(Math.floor(94*Math.random())+32))).join("")}s(5093);s(1818);function r(t){return{stype:"r",type:"s",id:t.id}}function o(t,e){return{stype:"r",type:"sv",id:t.id,data:e}}var a=s(3372);(0,a.vI)();class n{constructor(t,e,s){var o=this;let a;this.port=e,this._hasClosed=!1,this._id=void 0,this._handler=void 0,this._id=i(),this._handler=t,this.postMessage({stype:"e",type:"i",data:{instanceId:t.store.instanceId,schemaVersion:t.store.schema.version}}),e.onmessage=async function(e){if(o._hasClosed)throw console.error("Received message on dead port."),new Error("ERR_DEAD_PORT");clearTimeout(a),a=setTimeout((()=>{console.debug("Port",o.id,"timed out, removing"),t.killDeadPort(o)}),t.deadPortTimeout);const i=e.data;if("a"===i.type)o.postMessage(r(i));else try{const t=await s(i);o.postMessage(null!=t?t:r(i))}catch(e){o.postMessage(function(t,e){return{stype:"r",type:"e",id:t.id,data:e}}(i,e))}}}get id(){return this._id}postMessage(t){if(this._hasClosed)throw console.error("Attempted to send message on dead port."),new Error("ERR_DEAD_PORT");try{this.port.postMessage(t)}catch(e){this._handler.killDeadPort(this)}}close(){this._hasClosed&&console.error("Attempted to close already closed port:",this._id),"close"in this.port&&this.port.close(),this._hasClosed=!0}}var c=s(1175);s(2295);const h="http",l=/^application\/(.+\+)?json(;.*)?$/;function d(t){return{initialHydrate:!1,allowDirectMutation:!1,initialValue:{},pluginId:h,config:t}}const u={http:new class{constructor(){this._purge=new Map}async intercept(t,e,s){var i;this._purge.has(t[0])||this._purge.set(t[0],new Map);const r=this._purge.get(t[0]),o=JSON.parse(String(t[1])),a="string"==typeof e.config.query?e.config.query:e.config.query(o),n=t.slice(0,2),c=s.select(n),h=Date.now(),d=h-(null!=(i=null==c?void 0:c.ts)?i:0);if(!c||e.config.expireMs&&d>e.config.expireMs){const i={ts:h,v:await fetch(a).then((t=>{var e;return t.ok?l.test(null!=(e=t.headers.get("Content-Type"))?e:"")?t.json():t.text():Promise.reject(new Error(t.statusText))}))};r.get(t[1])&&(clearTimeout(r.get(t[1])),r.delete(t[1])),e.config.autoRefresh&&e.config.expireMs&&r.set(t[1],setTimeout((()=>{s.getWatchCount(t)&&s.selectValueAsync({type:"sv",data:t,id:-1})}),e.config.expireMs)),s.applyPatches([{path:[...n],op:"replace",value:i}])}return s.select(t)}}};var p=s(2093);function g(t){return p.z.record(p.z.string(),p.z.object({v:t,ts:p.z.number()}))}const y=p.z.number().int().positive(),m=p.z.object({id:y,userId:y,title:p.z.string(),completed:p.z.boolean()}),f=p.z.object({id:y,name:p.z.string(),username:p.z.string()}),_=p.z.object({id:y,userId:y,title:p.z.string()}),v=p.z.object({id:y,albumId:y,title:p.z.string(),url:p.z.string().url(),thumbnailUrl:p.z.string().url()}),w=p.z.object({valueA:p.z.object({counter:p.z.number().int()}),list:p.z.array(p.z.number()),todo:g(m),todoList:g(p.z.array(m)),user:g(f),album:g(_),albumList:g(p.z.array(_)),albumPhotosList:g(p.z.array(v))});const b={version:1,entries:{valueA:{initialValue:{counter:8},allowDirectMutation:!0},list:{initialValue:[],allowDirectMutation:!0},todo:d({query:t=>`https://jsonplaceholder.typicode.com/todos/${t}`,expireMs:15e3}),todoList:d({query:"https://jsonplaceholder.typicode.com/todos",expireMs:15e3}),user:d({query:t=>`https://jsonplaceholder.typicode.com/users/${t}`,expireMs:12e4}),albumList:d({query:"https://jsonplaceholder.typicode.com/albums",expireMs:12e4,autoRefresh:!0}),album:d({query:t=>`https://jsonplaceholder.typicode.com/albums/${t}`,expireMs:12e4}),albumPhotosList:d({query:t=>`https://jsonplaceholder.typicode.com/album/${t}/photos`,expireMs:12e4,autoRefresh:!0})},validateEntry(t,e){const s=w.shape[t].safeParse(e);if(!s.success&&"error"in s)return s.error.errors.map((t=>t.path.join(".")+": "+t.message)).join("\n")}};new class{constructor(t,e,s,r){this.storeId=t,this._handler=s,this._plugins=r,this._instanceId=void 0,this._state=void 0,this._schema=void 0,this._init=void 0,this._locks=new Map,this._instanceId=i(),this._schema=e,this._init=s.init(this)}async handleMessage(t){switch(await this._init,t.type){case"fv":return this.getSchemaEntry(t.data),function(t,e){return{stype:"r",type:"fv",id:t.id,data:e}}(t,this._state[t.data]);case"sv":return await this.selectValueAsync(t);case"m":if(!this.getSchemaEntry(t.data.key).allowDirectMutation){const e=`Schema does not allow direct mutation of key '${t.data.key}'`;throw console.error(e),new Error(e)}return this.applyPatches((e=t.data.patches,s=t.data.key,e.map((t=>Object.assign({},t,{path:[s,...t.path]}))))),r(t)}var e,s}async selectValueAsync(t){const e=this.getSchemaEntry(t.data[0]),s=JSON.stringify(t.data);for(console.debug("Req",s);this._locks.has(s);)console.debug("Lock on",s),await this._locks.get(s),console.debug("Unlock on",s);if("pluginId"in e){const i=this._plugins[e.pluginId].intercept(t.data,e,this);this._locks.set(s,i);const r=await i;return this._locks.delete(s),console.debug("Plugin",e.pluginId,"handled",s,"returning",r),o(t,r)}return o(t,this.select(t.data))}isEntryKey(t){return t in this.schema.entries}applyPatches(t){const e=(0,a.QE)(this._state,t),s=new Set(t.map((t=>String(t.path[0]))));for(const i of s)this.validateEntry(i,e[i]);this._state=e,this._handler.broadcastEvent({stype:"e",type:"m",data:t}),this._handler.notifyMutation()}validateEntry(t,e){if(!this.isEntryKey(t))throw new Error(`Invalid mutation; key '${t}' not listed in schema.`);if(this.schema.validateEntry){const s=this.schema.validateEntry(t,e);if(s)throw new Error(`Invalid mutation; key '${t}' failed validation: ${s}`)}}select(t){let e=this.state;for(const i of t){var s;if(null==e||"object"!=typeof e){e=void 0;break}e=null==(s=e)?void 0:s[i]}return e}get state(){return this._state}set state(t){for(const e in t)this.validateEntry(e,t[e]);this._state=t}getSchemaEntry(t){const e=this.schema.entries[t];if(!e)throw new Error(`Schema does not have an entry with key '${t}'`);return e}get schema(){return this._schema}get instanceId(){return this._instanceId}getWatchCount(t){return 1}}("testStoreId",b,new class{constructor(){this._store=void 0,this._ports=new Set,this._deadPortTimeout=6e4,this._storageKey=void 0,this._lastWriteTs=0,this._writeInterval=1e3,this._writeTimeout=void 0}async init(t){this._store=t,this._storageKey=`SStore__${this._store.storeId}`,this.startListening();const e=await(0,c.U2)(this._storageKey);this._store.state=Object.assign({},function(t){return Object.fromEntries(Object.entries(t.entries).map((([t,e])=>[t,e.initialValue])))}(this._store.schema),e),console.log("Initial State:",this._store.state)}startListening(){"onconnect"in globalThis?onconnect=t=>{this._ports.add(new n(this,t.ports[0],this.store.handleMessage.bind(this.store)))}:this._ports.add(new n(this,globalThis,this.store.handleMessage.bind(this.store)))}get store(){return this._store}get deadPortTimeout(){return this._deadPortTimeout}broadcastEvent(t){for(const e of Array.from(this._ports))e.postMessage(t)}killDeadPort(t){console.debug("Killing dead port"),this._ports.delete(t),t.close()}async persist(){this._lastWriteTs=Date.now(),this._writeTimeout=void 0,console.log("PERSISTING..."),await(0,c.t8)(this._storageKey,this._store.state),console.log("PERSISTED")}notifyMutation(){var t=this;this._writeTimeout||(this._writeTimeout=setTimeout((async function(){await t.persist()}),this._lastWriteTs-Date.now()+this._writeInterval))}},Object.assign({},u))}},i={};function r(t){var e=i[t];if(void 0!==e)return e.exports;var o=i[t]={exports:{}};return s[t](o,o.exports,r),o.exports}r.m=s,r.x=()=>{var t=r.O(void 0,[824],(()=>r(6142)));return t=r.O(t)},t=[],r.O=(e,s,i,o)=>{if(!s){var a=1/0;for(l=0;l<t.length;l++){for(var[s,i,o]=t[l],n=!0,c=0;c<s.length;c++)(!1&o||a>=o)&&Object.keys(r.O).every((t=>r.O[t](s[c])))?s.splice(c--,1):(n=!1,o<a&&(a=o));if(n){t.splice(l--,1);var h=i();void 0!==h&&(e=h)}}return e}o=o||0;for(var l=t.length;l>0&&t[l-1][2]>o;l--)t[l]=t[l-1];t[l]=[s,i,o]},r.d=(t,e)=>{for(var s in e)r.o(e,s)&&!r.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},r.f={},r.e=t=>Promise.all(Object.keys(r.f).reduce(((e,s)=>(r.f[s](t,e),e)),[])),r.u=t=>t+".23f8276ac025f1ec.esm.js",r.miniCssF=t=>{},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t;r.g.importScripts&&(t=r.g.location+"");var e=r.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var s=e.getElementsByTagName("script");s.length&&(t=s[s.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=t})(),(()=>{var t={928:1};r.f.i=(e,s)=>{t[e]||importScripts(r.p+r.u(e))};var e=self.webpackChunk=self.webpackChunk||[],s=e.push.bind(e);e.push=e=>{var[i,o,a]=e;for(var n in o)r.o(o,n)&&(r.m[n]=o[n]);for(a&&a(r);i.length;)t[i.pop()]=1;s(e)}})(),e=r.x,r.x=()=>r.e(824).then(e);r.x()})();